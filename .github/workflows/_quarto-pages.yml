name: Render and Deploy Chirpy+Quarto Website

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # Cache R binaries and libraries (R installation itself caching is limited; we use setup-r action)
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3.1'  # specify your desired R version

    - name: Cache R packages
      uses: actions/cache@v4
      id: cache-r-packages
      with:
        path: ${{ env.R_LIBS_USER }}
        key: ${{ runner.os }}-r-packages-${{ hashFiles('DESCRIPTION', 'renv.lock', 'packages.R') }}
        restore-keys: |
          ${{ runner.os }}-r-packages-

    - name: Install R packages
      if: steps.cache-r-packages.outputs.cache-hit != 'true'
      run: |
        Rscript -e 'install.packages(c("renv","knitr","rmarkdown"))'
        Rscript -e 'renv::snapshot()'
        #Rscript -e 'renv::restore()'  # or install packages manually here

    - name: Set up Quarto
      uses: quarto-dev/quarto-actions/setup@v2
      env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          # To install LaTeX to build PDF book 
          tinytex: true 
   # - name: Setup Quarto
      #uses: quarto-dev/quarto-actions/setup@v2
      #with:
        #tinytex: true
        #version: "latest"


  #   # Cache Quarto CLI binaries
  #   - name: Cache Quarto
  #     uses: actions/cache@v4
  #     id: cache-quarto
  #     with:
  #       path: ~/.quarto/bin
  #       key: ${{ runner.os }}-quarto-${{ hashFiles('**/*.qmd','**/_quarto.yml') }}
  #       restore-keys: |
  #         ${{ runner.os }}-quarto-

  #   - name: Install Quarto if not cached
  #     if: steps.cache-quarto.outputs.cache-hit != 'true'
  #     - uses: quarto-dev/quarto-actions/setup@v2
  # with:
  #   tinytex: true

      # run: |
      #   wget https://github.com/quarto-dev/quarto-cli/releases/download/v1.3.340/quarto-1.3.340-linux-amd64.deb
      #   sudo dpkg -i quarto-1.3.340-linux-amd64.deb
      #   quarto install tinytex
    - name: Setup Pages
      id: pages
      uses: actions/configure-pages@v4
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
          ruby-version: 3.3
          bundler-cache: true

    - name: Build jekyll site
      run: bundle exec jekyll b -d "_site"
      env:
          JEKYLL_ENV: "production"

    # - name: Upload jekyll artifacts 
    #   uses: actions/upload-pages-artifact@v3
    #   with:
    #       path: "_site${{ steps.pages.outputs.base_path }}"

    - name: Render Quarto site
      run: |
        quarto render _qmd/ -P reload:false
        ls
        echo "q0 content..."
        #ls q0

    # - name: Deploy to GitHub Pages
    #   uses: peaceiris/actions-gh-pages@v4
    #   if: github.ref == 'refs/heads/main'
    #   with:
    #     github_token: ${{ secrets.GITHUB_TOKEN }}
    #     publish_dir: ./q
    - name: Prepare combined site
      run: |
          mkdir site
          ls _site
          cp -r _site/* site/
          cp -r q site/q
    - name: Upload site artifact
      uses: actions/upload-pages-artifact@v3
      with:
          path: "./site"

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: render
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
